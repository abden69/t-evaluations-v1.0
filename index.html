<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù†Ø¸Ø§Ù… ØªÙ‚ÙŠÙŠÙ… Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† â€” Ø¥ØµØ¯Ø§Ø± 1.0 </title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f8f9f8; --card:#ffffff; --emerald-dark:#0f5132; --emerald:#198754; --emerald-2:#2ea26d;
    --table-head:#e9f5ec; --muted:#4f5d52; --danger:#d9534f; --gold-highlight:#fff7e6;
    --gold-border: rgba(255,170,0,0.12); --shadow: 0 10px 30px rgba(15,81,50,0.06); --radius:10px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);font-family:'Cairo',sans-serif;color:#071123;line-height:1.5;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
  }
  .container{max-width:1200px;margin:18px auto;padding:18px;}
  .header{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:16px 18px;border-radius:var(--radius);
          background: linear-gradient(90deg,var(--emerald),var(--emerald-2));color:#fff;box-shadow: var(--shadow);}
  .header .title{font-weight:900;font-size:1.05rem;}
  .nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px;}
  .nav button{background:transparent;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:800;color:var(--emerald-dark);}
  .nav button:hover{transform:translateY(-3px);color:var(--emerald);}
  .nav button.active{background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.86)); box-shadow: 0 8px 18px rgba(15,81,50,0.06);}
  .card{background:var(--card);padding:14px;border-radius:var(--radius);margin-top:12px;box-shadow: 0 8px 26px rgba(10,25,18,0.03);border: 1px solid rgba(15,81,50,0.03);}
  .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;padding:9px 14px;border-radius:9px;border:0;cursor:pointer;font-weight:800;color:#fff;background: linear-gradient(90deg,var(--emerald),var(--emerald-2));box-shadow: 0 8px 20px rgba(15,81,50,0.08);transition: transform 180ms, box-shadow 180ms;}
  .btn:hover{transform: translateY(-4px);box-shadow: 0 16px 36px rgba(15,81,50,0.12);}
  .btn.ghost{background: transparent;color: var(--emerald-dark);border:1px solid rgba(15,81,50,0.06);box-shadow:none;}
  .btn.danger{background: linear-gradient(90deg,#e64a3c,#d9534f);color:#fff;}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #e6efe8;background: linear-gradient(180deg, #fff, #fbfdfb);outline:none;}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:0.95rem;overflow:auto;}
  .table th, .table td{padding:10px;text-align:right;vertical-align:middle;border-bottom:1px solid #f1f6f1;}
  .table th{background:var(--table-head);font-weight:900;color:var(--emerald-dark);position:sticky;top:0;z-index:2;}
  .small{ font-size:13px;color:var(--muted) }
  .toast{position:fixed;top:18px;right:18px;padding:12px 16px;border-radius:10px;background: linear-gradient(90deg,var(--emerald),var(--emerald-2));color:#fff;font-weight:800;display:none;z-index:9999;box-shadow: 0 8px 28px rgba(15,81,50,0.12);}
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,8,0.45);display:none;align-items:center;justify-content:center;z-index:2000;}
  .modal{background:var(--card);padding:16px;border-radius:10px;max-width:760px;width:94%;box-shadow: 0 18px 44px rgba(10,25,18,0.06);}
  @media(max-width:900px){ .row{flex-direction:column} .header{flex-direction:column;align-items:flex-start;gap:8px} }
  /* ğŸ”´ ØªØ®ØµÙŠØµ Ù…Ø¸Ù‡Ø± checkbox Ù„ÙŠØ¹Ø±Ø¶ X Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± */
input[type="checkbox"] {
  appearance: none;
  -webkit-appearance: none;
  width: 20px;
  height: 20px;
  border: 2px solid #bbb;
  border-radius: 4px;
  display: inline-block;
  position: relative;
  cursor: pointer;
  vertical-align: middle;
  margin-left: 6px;
}

input[type="checkbox"]:checked {
  border-color: #d9534f; /* Ø£Ø­Ù…Ø± */
  background-color: #ffe5e5;
}

input[type="checkbox"]:checked::after {
  content: "âœ–"; /* Ø¹Ù„Ø§Ù…Ø© X */
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -52%);
  font-size: 14px;
  color: #d9534f;
  font-weight: bold;
}

</style>
</head>
<body>
<div class="container">

  <header class="header">
    <div class="title">ğŸ“ Ù†Ø¸Ø§Ù… ØªÙ‚ÙŠÙŠÙ… Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† â€” (Ø§Ù„Ø¥ØµØ¯Ø§Ø± 1.0)</div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="backupTop" class="btn ghost">ğŸ’¾</button>
    </div>
  </header>

  <nav class="nav" id="mainNav">
    <button class="nav-btn" data-screen="teachers">Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</button>
    <button class="nav-btn" data-screen="criteria">Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
    <button class="nav-btn" data-screen="daily">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙŠÙˆÙ…ÙŠ</button>
    <button class="nav-btn" data-screen="weekly">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</button>
    <button class="nav-btn" data-screen="monthly">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø´Ù‡Ø±ÙŠ</button>
    <button class="nav-btn" data-screen="attendance">Ø§Ù„Ø­Ø¶ÙˆØ±</button>
    <button class="nav-btn" data-screen="absences">Ø§Ù„ØºÙŠØ§Ø¨</button>
    <button class="nav-btn" data-screen="summaryReport">ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®ØªØµØ±</button>
    <button class="nav-btn" data-screen="fullReport">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„</button>
    <button class="nav-btn" data-screen="settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    <button class="nav-btn" data-screen="teacherReport">ğŸ“„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…ÙØµÙ‘Ù„</button>
</nav>

  <!-- Teachers -->
  <section id="teachers" class="card screen" style="display:none">
    <h3>Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</h3>
    <label class="small">Ø§Ù„Ø§Ø³Ù…</label><input id="t_name">
    <div class="row" style="margin-top:8px">
      <div><label class="small">Ø§Ù„Ø±Ù‚Ù…</label><input id="t_id"></div>
      <div><label class="small">Ø§Ù„Ù…Ø§Ø¯Ø©</label><input id="t_subject"></div>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px">
      <button id="addTeacher" class="btn">Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù‘Ù…</button>
      <input type="file" id="importFile" accept=".xlsx,.xls,.csv" style="display:none">
      <button id="btnImportFile" class="btn ghost">ğŸ“‚ ØªØ­Ù…ÙŠÙ„ Ù…Ù† Excel/CSV</button>
    </div>
    <div style="margin-top:12px">
      <table class="table" id="teachersTable">
        <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø¹Ù…Ù„ÙŠØ§Øª</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Criteria -->
  <section id="criteria" class="card screen" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h3>Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h3>
        <div class="small">Ø£Ø¶Ù Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙˆØ­Ø¯Ø¯ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ ÙˆØ§Ù„Ù†ÙˆØ¹ ÙˆÙ‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ… Ù„ÙƒÙ„ Ù…Ù‚ØµØ±</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="restoreDefaults" class="btn ghost">ğŸ”„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <div class="row">
        <div>
          <label class="small">Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯</label>
          <input id="ci_name" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ØªØ­Ø¶ÙŠØ±">
        </div>
        <div>
          <label class="small">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰</label>
          <input id="ci_max" type="number" min="1" value="10">
        </div>
        <div>
          <label class="small">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯</label>
          <select id="ci_kind">
            <option value="daily">ÙŠÙˆÙ…ÙŠ</option>
            <option value="weekly">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>
            <option value="monthly">Ø´Ù‡Ø±ÙŠ</option>
          </select>
        </div>
        <div>
          <label class="small">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ… (Ù„ÙƒÙ„ Ù…Ù‚ØµØ±)</label>
          <input id="ci_penalty" type="number" min="0" step="0.1" value="1">
        </div>
      </div>
      <div style="margin-top:8px"><button id="addCi" class="btn">â• Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯</button></div>

      <div style="margin-top:12px">
        <table class="table" id="ci_table">
          <thead>
            <tr><th>Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…</th><th>Ø¹Ù…Ù„ÙŠØ§Øª</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- DAILY (Ù…Ø¹Ù„Ù…ÙŠ ØµÙÙˆÙ + Ø¨Ù†ÙˆØ¯ Ø£Ø¹Ù…Ø¯Ø© Ù…Ø¹ checkboxes) -->
  <section id="daily" class="card screen" style="display:none">
    <h3>Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
    <div class="small">Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ­Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„Ù…Ù‚ØµØ±ÙŠÙ† Ø¹Ø¨Ø± Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</div>
    <div class="row" style="margin-top:8px">
      <div><label class="small">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="daily_date" type="date"></div>
    </div>
    <div style="margin-top:12px;overflow:auto">
      <div id="daily_table_wrap"></div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px">
      <button id="saveDaily" class="btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© (ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª)</button>
      <button id="clearDaily" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„Ø¹Ø±ÙˆØ¶</button>
    </div>
    <div style="margin-top:12px">
      <table class="table" id="daily_sessions_table">
        <thead id="daily_head"></thead><tbody id="daily_body"></tbody>
      </table>
    </div>
  </section>

  <!-- WEEKLY -->
  <section id="weekly" class="card screen" style="display:none">
    <h3>Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h3>
    <div class="small">Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ­Ø¯Ø¯ Ø§Ù„Ù…Ù‚ØµØ±ÙŠÙ†</div>
    <div class="row" style="margin-top:8px"><div><label class="small">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="weekly_date" type="date"></div></div>
    <div style="margin-top:12px;overflow:auto"><div id="weekly_table_wrap"></div></div>
    <div style="margin-top:10px;display:flex;gap:8px"><button id="saveWeekly" class="btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© (ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª)</button><button id="clearWeekly" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„Ø¹Ø±ÙˆØ¶</button></div>
    <div style="margin-top:12px"><table class="table" id="weekly_sessions_table"><thead id="weekly_head"></thead><tbody id="weekly_body"></tbody></table></div>
  </section>

  <!-- MONTHLY -->
  <section id="monthly" class="card screen" style="display:none">
    <h3>Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3>
    <div class="small">Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ­Ø¯Ø¯ Ø§Ù„Ù…Ù‚ØµØ±ÙŠÙ†</div>
    <div class="row" style="margin-top:8px"><div><label class="small">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="monthly_date" type="date"></div></div>
    <div style="margin-top:12px;overflow:auto"><div id="monthly_table_wrap"></div></div>
    <div style="margin-top:10px;display:flex;gap:8px"><button id="saveMonthly" class="btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© (ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª)</button><button id="clearMonthly" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„Ø¹Ø±ÙˆØ¶</button></div>
    <div style="margin-top:12px"><table class="table" id="monthly_sessions_table"><thead id="monthly_head"></thead><tbody id="monthly_body"></tbody></table></div>
  </section>

  <!-- Attendance -->
  <section id="attendance" class="card screen" style="display:none">
    <h3>Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</h3>
    <label class="small">Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù‘Ù…</label><select id="attendance_teacher"></select>
    <div class="row" style="margin-top:8px">
      <div><label class="small">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="att_date" type="date"></div>
      <div><label class="small">ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ±</label><input id="att_arrival" type="time" value="07:00"></div>
      <div><label class="small">ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</label><input id="att_leave" type="time" value="13:25"></div>
    </div>
    <div style="margin-top:8px">
      <button id="saveAttendance" class="btn">Ø­ÙØ¸ (ÙŠØ­Ø³Ø¨ Ø§Ù„Ø®ØµÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)</button>
      <button id="clearAttendance" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
    </div>
    <div style="margin-top:12px">
      <table class="table" id="attendance_table">
        <thead><tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø¶ÙˆØ±</th><th>Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</th><th>ØªØ£Ø®Ø±</th><th>Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ±</th><th>Ø®ØµÙ…</th><th>Ø­Ø°Ù</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Absences -->
  <section id="absences" class="card screen" style="display:none">
    <h3>Ø§Ù„ØºÙŠØ§Ø¨</h3>
    <label class="small">Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù‘Ù…</label><select id="absence_teacher"></select>
    <div class="row" style="margin-top:8px">
      <div><label class="small">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="abs_date" type="date"></div>
      <div><label class="small">Ø§Ù„Ù†ÙˆØ¹</label><select id="abs_type"><option value="excused">Ø¨Ø¹Ø°Ø±</option><option value="unexcused">Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±</option></select></div>
      <div id="abs_penalty_wrap" style="display:none"><label class="small">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…</label><input id="abs_penalty" type="number" min="0" step="0.5"></div>
    </div>
    <div style="margin-top:8px">
      <button id="saveAbsence" class="btn">Ø­ÙØ¸ Ø§Ù„ØºÙŠØ§Ø¨</button>
      <button id="clearAbsence" class="btn ghost">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
    </div>
    <div style="margin-top:12px">
      <table class="table" id="absence_table">
        <thead><tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø®ØµÙ…</th><th>Ø­Ø°Ù</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Summary Report -->
  <section id="summaryReport" class="card screen" style="display:none">
    <h3>ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®ØªØµØ±</h3>
    <div class="small" id="reportDate" style="margin-bottom:10px;"></div>
    <table class="table">
      <thead id="summary_head"></thead>
      <tbody id="summary_body"></tbody>
    </table>
    <div id="bestTeacher" style="margin-top:10px;font-weight:bold;font-size:1.1rem;color:var(--emerald-dark);"></div>
    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
      <button id="exportExcel" class="btn">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
      <button id="exportPdf" class="btn ghost">ğŸ§¾ ØªØµØ¯ÙŠØ± PDF</button>
    </div>
  </section>

  <!-- Full report -->
  <section id="fullReport" class="card screen" style="display:none">
    <h3>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„</h3>
    <div style="margin-top:12px"><table class="table" id="full_table"><thead id="full_head"></thead><tbody id="full_body"></tbody><tfoot id="full_foot"></tfoot></table></div>
    <div style="margin-top:12px"><button id="printFull" class="btn ghost">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button></div>
  </section>

  <!-- Settings -->
  <section id="settings" class="card screen" style="display:none">
    <h3>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
    <div class="row">
      <div><label class="small">ÙˆÙ‚Øª Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ø±Ø³Ù…ÙŠ</label><input type="time" id="official_start" value="07:00"></div>
      <div><label class="small">ÙˆÙ‚Øª Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„Ø±Ø³Ù…ÙŠ</label><input type="time" id="official_end" value="13:25"></div>
      <div><label class="small">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø®ØµÙ… Ø§Ù„ØªØ£Ø®Ø±/Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</label><input type="number" id="max_att" min="0" step="0.5" value="2"></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
      <button id="backup" class="btn">ğŸ’¾ ØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
      <button id="restore" class="btn ghost">ğŸ“¤ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø©</button>
      <button id="resetAll" class="btn danger">ğŸ§¹ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button>
    </div>
  </section>

  <div class="toast" id="toast"></div>

  <!-- Confirm modal -->
  <div id="confirmModal" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <div id="modalMessage" style="font-weight:900;font-size:1rem;margin-bottom:12px;">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</div>
      <div style="display:flex;justify-content:flex-end;gap:8px;">
        <button id="modalOk" class="btn">Ù…ÙˆØ§ÙÙ‚</button>
        <button id="modalCancel" class="btn ghost">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

</div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
/* ====== index27_full24_v3 â€” Ø³ÙƒØ±Ø¨Øª Ù…ÙØµÙ„Ø­ ====== */
(function(){
const STORAGE = 'index27_v2_state_v3';
let state = {
  teachers: [],
  criteria: [],
  evaluations: [],
  deductions: [],
  attendance: [],
  absences: [],
  official: {start:'07:00', end:'13:25', maxAttendancePenalty:2}
};

const DEFAULT_CRITERIA = [
  {id:'c_daily_1',name:'Ø§Ù„Ø·Ø§Ø¨ÙˆØ± Ø§Ù„ØµØ¨Ø§Ø­ÙŠ',kind:'daily',max:10,penalty:1},
  {id:'c_daily_2',name:'Ø§Ù„Ø¥Ù„ØªØ²Ø§Ù… Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø­ØµØµ',kind:'daily',max:10,penalty:1},
  {id:'c_daily_3',name:'Ø§Ù„Ø²ÙŠ Ø§Ù„Ø±Ø³Ù…ÙŠ',kind:'daily',max:10,penalty:0.5},
  {id:'c_week_1',name:'Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ',kind:'weekly',max:10,penalty:1},
  {id:'c_week_2',name:'Ø³Ø¬Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©',kind:'weekly',max:10,penalty:1},
  {id:'c_week_3',name:'Ù…Ù†Ø§ÙˆØ¨Ø© Ø§Ù„ÙØ³Ø­Ø©',kind:'weekly',max:10,penalty:1},
  {id:'c_week_4',name:'Ù…Ù†Ø§ÙˆØ¨Ø© Ø§Ù„ØµÙ„Ø§Ø©',kind:'weekly',max:10,penalty:1},
  {id:'c_month_1',name:'Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ø¥Ø°Ø§Ø¹Ø©',kind:'monthly',max:10,penalty:1}

];

function save(){ try{ localStorage.setItem(STORAGE, JSON.stringify(state)); }catch(e){ console.error('Save failed', e); } }
function load(){
  const raw = localStorage.getItem(STORAGE);
  if(raw){
    try{ state = JSON.parse(raw); }
    catch(e){ state.criteria = DEFAULT_CRITERIA.slice(); }
  }
  if(!Array.isArray(state.criteria) || state.criteria.length===0) state.criteria = DEFAULT_CRITERIA.slice();
  if(!Array.isArray(state.teachers)) state.teachers = [];
  if(!Array.isArray(state.deductions)) state.deductions = [];
  if(!Array.isArray(state.evaluations)) state.evaluations = [];
  save();
}

function uid(p='id'){ return p + '_' + Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function el(q){ return document.querySelector(q); }
function els(q){ return Array.from(document.querySelectorAll(q)); }
function toast(msg){ const t=el('#toast'); if(!t) return; t.textContent = msg; t.style.display = 'block'; setTimeout(()=> t.style.display='none',2200); }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function minutesBetween(t1,t2){ if(!t1||!t2) return 0; const a=t1.split(':').map(Number); const b=t2.split(':').map(Number); return (b[0]*60+b[1]) - (a[0]*60+a[1]); }
function confirmModal(msg){ return new Promise(res=>{ const md=document.getElementById('confirmModal'); if(!md) return res(false); document.getElementById('modalMessage').textContent=msg; md.style.display='flex'; const ok=document.getElementById('modalOk'), cancel=document.getElementById('modalCancel'); function cleanup(){ md.style.display='none'; ok.removeEventListener('click', onok); cancel.removeEventListener('click', oncancel); } function onok(){ cleanup(); res(true); } function oncancel(){ cleanup(); res(false); } ok.addEventListener('click', onok); cancel.addEventListener('click', oncancel); }); }

/* ---------- Teachers ---------- */
function renderTeachers(){
  const tbody = el('#teachersTable tbody'); if(!tbody) return; tbody.innerHTML='';
  state.teachers.forEach(t=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(t.name)}</td><td>${escapeHtml(t.id)}</td><td>${escapeHtml(t.subject||'')}</td>
      <td><button class="btn ghost editTeacher" data-id="${t.id}">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn" data-act="delTeacher" data-id="${t.id}" style="background:var(--danger);color:#fff">Ø­Ø°Ù</button></td>`;
    tbody.appendChild(tr);
  });
  els('.editTeacher').forEach(b=> b.addEventListener('click', e=> startEditTeacher(e.currentTarget.dataset.id)));
  els('[data-act="delTeacher"]').forEach(b=> b.addEventListener('click', async e=>{
    const id = e.currentTarget.dataset.id; const ok = await confirmModal('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ù„Ù… ÙˆÙƒÙ„ Ø³Ø¬Ù„Ø§ØªÙ‡ØŸ'); if(!ok) return;
    deleteTeacher(id);
  }));
}
function addTeacher(){
  const name = el('#t_name').value.trim(); const id = el('#t_id').value.trim(); const subject = el('#t_subject').value.trim();
  if(!name||!id){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù„Ù…'); return; }
  if(state.teachers.some(t=>t.id===id)){ alert('Ø§Ù„Ø±Ù‚Ù… Ù…ÙˆØ¬ÙˆØ¯'); return; }
  state.teachers.push({id,name,subject}); save(); renderTeachers(); populateSelects(); el('#t_name').value=''; el('#t_id').value=''; el('#t_subject').value=''; toast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ù„Ù…');
}
function startEditTeacher(id){
  const t = state.teachers.find(x=> x.id===id); if(!t) return;
  el('#t_name').value = t.name; el('#t_id').value = t.id; el('#t_subject').value = t.subject||'';
  const btn = el('#addTeacher'); btn.textContent='Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'; btn.onclick = ()=> saveEditTeacher(id);
}
function saveEditTeacher(id){
  const t = state.teachers.find(x=> x.id===id); if(!t) return;
  t.name = el('#t_name').value.trim(); t.subject = el('#t_subject').value.trim(); save();
  renderTeachers(); populateSelects();
  el('#addTeacher').textContent='Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù‘Ù…'; el('#addTeacher').onclick = addTeacher;
  el('#t_name').value=''; el('#t_id').value=''; el('#t_subject').value='';
  toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
}
function deleteTeacher(id){
  state.teachers = state.teachers.filter(t=> t.id!==id);
  state.deductions = state.deductions.filter(d=> d.teacherId !== id);
  state.evaluations = state.evaluations.filter(e=> {
    if(!e.deductionIds) return true;
    e.deductionIds = e.deductionIds.filter(i => {
      const d = state.deductions.find(dd => dd.id === i);
      return !!d;
    });
    return e.deductionIds.length > 0;
  });
  state.attendance = state.attendance.filter(a=> a.teacherId !== id);
  state.absences = state.absences.filter(a=> a.teacherId !== id);
  save(); renderTeachers(); populateSelects(); renderAllTables(); toast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
}

/* ---------- Criteria (Ù…Ø¹ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…) ---------- */
function renderCriteria(){
  const tbody = el('#ci_table tbody'); if(!tbody) return; tbody.innerHTML='';
  (state.criteria||[]).forEach(c=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(c.name)}</td><td class="center">${c.max}</td><td>${escapeHtml(c.kind)}</td><td class="center">${c.penalty}</td>
      <td><button class="btn ghost editCi" data-id="${c.id}">ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn" data-id="${c.id}" data-act="delCi" style="background:var(--danger);color:#fff">Ø­Ø°Ù</button></td>`;
    tbody.appendChild(tr);
  });
  els('.editCi').forEach(b=> b.addEventListener('click', e=> startEditCi(e.currentTarget.dataset.id)));
  els('[data-act="delCi"]').forEach(b=> b.addEventListener('click', async e=>{
    const id = e.currentTarget.dataset.id; const ok = await confirmModal('Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯ØŸ'); if(!ok) return;
    const removedDedIds = state.deductions.filter(d=> d.criteriaId===id).map(d=> d.id);
    state.criteria = state.criteria.filter(x=> x.id !== id);
    state.deductions = state.deductions.filter(d=> d.criteriaId !== id);
    state.evaluations = state.evaluations.map(sess=> ({...sess, deductionIds: sess.deductionIds ? sess.deductionIds.filter(i=> !removedDedIds.includes(i)) : []}))
                                       .filter(s=> !s.deductionIds || s.deductionIds.length>0);
    save(); renderCriteria(); renderAllTables(); toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯ ÙˆØ§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ù‡');
  }));
}
function addCriterion(){
  const name = el('#ci_name').value.trim(); const kind = el('#ci_kind').value; let max = Number(el('#ci_max').value); let penalty = Number(el('#ci_penalty').value);
  if(!name) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯'); if(!max || max<=0) max = 10; if(isNaN(penalty) || penalty<0) penalty = 0;
  const id = uid('ci');
  state.criteria.push({id,name,kind,max,penalty}); save();
  el('#ci_name').value=''; el('#ci_max').value=10; el('#ci_kind').value='daily'; el('#ci_penalty').value=1;
  renderCriteria(); renderAllTables(); populateSelects();
  toast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù†Ø¯ Ù…Ø¹ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…');
}
function startEditCi(id){
  const c = state.criteria.find(x=> x.id===id); if(!c) return;
  el('#ci_name').value = c.name; el('#ci_max').value = c.max; el('#ci_kind').value = c.kind; el('#ci_penalty').value = c.penalty;
  const btn = el('#addCi'); btn.textContent='Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'; btn.onclick = ()=> saveEditCi(id);
}
function saveEditCi(id){
  const c = state.criteria.find(x=> x.id===id); if(!c) return;
  c.name = el('#ci_name').value.trim(); c.max = Number(el('#ci_max').value) || c.max; c.kind = el('#ci_kind').value; c.penalty = Number(el('#ci_penalty').value) || 0;
  save(); el('#addCi').textContent='â• Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯'; el('#ci_name').value=''; el('#ci_max').value=10; el('#ci_kind').value='daily'; el('#ci_penalty').value=1;
  renderCriteria(); renderAllTables(); populateSelects(); toast('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ù†Ø¯ ÙˆÙ‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…');
}
function restoreDefaults(){
  const ok = confirm('Ø³ÙŠØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ù„Ù† ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª). Ù…ØªØ§Ø¨Ø¹Ø©ØŸ'); if(!ok) return;
  state.criteria = DEFAULT_CRITERIA.slice(); save(); renderCriteria(); renderAllTables(); populateSelects(); toast('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©');
}

/* ---------- Populate selects ---------- */
function populateSelects(){
  ['attendance_teacher','absence_teacher'].forEach(id=>{
    const sel = el('#'+id); if(!sel) return; const prev = sel.value; sel.innerHTML = '';
    const ph = document.createElement('option'); ph.value=''; ph.textContent='-- Ø§Ø®ØªØ± --'; sel.appendChild(ph);
    state.teachers.forEach(t=> { const o = document.createElement('option'); o.value = t.id; o.textContent = t.name + (t.subject?(' â€” '+t.subject):''); sel.appendChild(o); });
    sel.value = prev;
  });
}

/* ---------- Build grid for kind ---------- */
function buildGridForKind(kind){
  const wrap = el('#'+kind+'_table_wrap'); if(!wrap) return;
  wrap.innerHTML = '';
  const crits = (state.criteria||[]).filter(c=> c.kind===kind);
  const teachers = state.teachers || [];
  if(crits.length===0){ wrap.innerHTML = '<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹</div>'; return; }
  const tbl = document.createElement('table'); tbl.className = 'table';
  const thead = document.createElement('thead'); const thr = document.createElement('tr');
  thr.innerHTML = '<th>Ø§Ù„Ù…Ø¹Ù„Ù…</th>';
  crits.forEach(c=> thr.innerHTML += `<th>${escapeHtml(c.name)}<div class="small">(-${c.penalty})</div></th>`);
  thr.innerHTML += '<th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø®ØµÙ…</th>';
  thead.appendChild(thr); tbl.appendChild(thead);
  const tbody = document.createElement('tbody');
  teachers.forEach(t=>{
    const tr = document.createElement('tr');
    let cells = `<td>${escapeHtml(t.name)}</td>`;
    crits.forEach(c=>{
      const chkId = `chk_${kind}_${c.id}_${t.id}`;
      cells += `<td class="center"><input type="checkbox" id="${chkId}" data-kind="${kind}" data-criteria="${c.id}" data-teacher="${t.id}"></td>`;
    });
    cells += `<td class="center sum-cell" data-teacher="${t.id}">0</td>`;
    tr.innerHTML = cells;
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
  wrap.appendChild(tbl);
  tbody.querySelectorAll('input[type="checkbox"]').forEach(chk=>{
    chk.addEventListener('change', ()=> updateGridSums(kind));
  });
}
function updateGridSums(kind){
  const crits = (state.criteria||[]).filter(c=> c.kind===kind);
  const tbody = el('#'+kind+'_table_wrap tbody'); if(!tbody) return;
  const rows = Array.from(tbody.querySelectorAll('tr'));
  rows.forEach(row=>{
    const teacherId = row.querySelector('.sum-cell').dataset.teacher;
    let total = 0;
    crits.forEach(c=>{
      const chk = row.querySelector(`input[data-criteria="${c.id}"][data-teacher="${teacherId}"]`);
      if(chk && chk.checked) total += Number(c.penalty || 0);
    });
    row.querySelector('.sum-cell').textContent = total;
  });
}

/* ---------- Save grid session ---------- */
function saveGridSession(kind){
  const dateInput = el('#'+kind+'_date'); const dateVal = dateInput ? dateInput.value : '';
  if(!dateVal){ alert('Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ù„Ø³Ø©'); return; }
  const crits = (state.criteria||[]).filter(c=> c.kind===kind);
  const tbody = el('#'+kind+'_table_wrap tbody'); if(!tbody) return;
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const createdDedIds = [];
  rows.forEach(row=>{
    const teacherId = row.querySelector('.sum-cell').dataset.teacher;
    crits.forEach(c=>{
      const chk = row.querySelector(`input[data-criteria="${c.id}"][data-teacher="${teacherId}"]`);
      if(chk && chk.checked){
        const ded = { id: uid('ded'), teacherId, criteriaId: c.id, kind, date: new Date(dateVal).toISOString(), deduction: Number(c.penalty || 0), note: '' };
        state.deductions.push(ded);
        createdDedIds.push(ded.id);
      }
    });
  });
  if(createdDedIds.length===0){ alert('Ù„Ù… ØªØ­Ø¯Ø¯ Ø£ÙŠ Ù…Ù‚ØµØ±ÙŠÙ† (Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ÙØ§Ø±ØºØ©)'); return; }
  const sess = { id: uid('sess'), kind, date: new Date(dateVal).toISOString(), deductionIds: createdDedIds };
  state.evaluations.push(sess);
  save();
  renderSessions(kind);
  rows.forEach(r=> r.querySelectorAll('input[type="checkbox"]').forEach(c=> c.checked = false));
  updateGridSums(kind);
  toast(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØªØ·Ø¨ÙŠÙ‚ ${createdDedIds.length} Ø®ØµÙ…Ù‹Ø§`);
}

/* ---------- Render sessions (Ù…ØµØ­Ø­: Ù„Ø§ Ø£Ø®Ø·Ø§Ø¡ Ù†Ø­ÙˆÙŠØ© Ù‡Ù†Ø§) ---------- */
function renderSessions(kind){
  const headEl = el('#'+kind+'_head'); const bodyEl = el('#'+kind+'_body');
  if(!headEl || !bodyEl) return;
  headEl.innerHTML = ''; bodyEl.innerHTML = '';
  const crits = state.criteria.filter(c=> c.kind===kind);
  // header
  let trh = document.createElement('tr');
  trh.innerHTML = '<th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>';
  crits.forEach(c=> trh.innerHTML += `<th>${escapeHtml(c.name)}</th>`);
  trh.innerHTML += '<th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø­Ø°Ù</th>';
  headEl.appendChild(trh);
  // sessions
  const rows = state.evaluations.filter(s=> s.kind===kind);
  rows.forEach(sess=>{
    const tIds = Array.from(new Set((sess.deductionIds||[]).map(id=>{
      const d = state.deductions.find(x=> x.id===id); return d? d.teacherId : null;
    }).filter(Boolean)));
    tIds.forEach(tid=>{
      const t = state.teachers.find(x=> x.id===tid) || {name:'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'};
      const tr = document.createElement('tr');
      let inner = `<td>${escapeHtml(t.name)}</td><td>${new Date(sess.date).toLocaleString()}</td>`;
      let total = 0;
      crits.forEach(c=>{
        const totalDedForThis = state.deductions.filter(d=> d.teacherId===tid && d.criteriaId===c.id && d.kind===kind && (sess.deductionIds||[]).includes(d.id)).reduce((s,i)=> s + Number(i.deduction || 0),0);
        const final = Math.max(0, c.max - totalDedForThis);
        inner += `<td class="center">${final}<div class="small">(-${totalDedForThis})</div></td>`;
        total += final;
      });
      inner += `<td class="center">${total}</td><td class="center"><button class="btn" data-id="${sess.id}" data-kind="${kind}" style="background:var(--danger);color:#fff">Ø­Ø°Ù</button></td>`;
      tr.innerHTML = inner;
      bodyEl.appendChild(tr);
    });
  });
  // bind delete session buttons
  bodyEl.querySelectorAll('button[data-id]').forEach(b=> b.addEventListener('click', async e=>{
    const id = e.currentTarget.dataset.id; const ok = await confirmModal('Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø©ØŸ'); if(!ok) return;
    const sess = state.evaluations.find(s=> s.id===id);
    if(sess && sess.deductionIds && Array.isArray(sess.deductionIds)){
      state.deductions = state.deductions.filter(d=> !sess.deductionIds.includes(d.id));
    }
    state.evaluations = state.evaluations.filter(s=> s.id !== id);
    save(); renderSessions(e.currentTarget.dataset.kind); toast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
  }));
}

/* ---------- Helper to render grid + sessions for a kind ---------- */
function renderGridAndSessions(kind){
  buildGridForKind(kind);
  renderSessions(kind);
  updateGridSums(kind);
}

/* ---------- Render all ---------- */
function renderAllTables(){
  renderGridAndSessions('daily');
  renderGridAndSessions('weekly');
  renderGridAndSessions('monthly');
  renderAttendanceTable(); renderAbsences(); renderFullReport(); renderSummaryReport();
}

/* ---------- Attendance & Absences ---------- */
function saveAttendance(){
  const sel = el('#attendance_teacher'); if(!sel || !sel.value) return alert('Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹');
  const date = el('#att_date').value; if(!date) return alert('Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®');
  const arrival = el('#att_arrival').value; const leave = el('#att_leave').value;
  const officialStart = el('#official_start').value || state.official.start; const officialEnd = el('#official_end').value || state.official.end;
  const late = Math.max(0, minutesBetween(officialStart, arrival));
  const early = Math.max(0, minutesBetween(leave, officialEnd));
  const total = late + early; const steps = Math.floor(total/30); let ded = steps * 0.5; const cap = Number(el('#max_att').value) || state.official.maxAttendancePenalty || 2; if(ded>cap) ded = cap;
  const rec = {id: uid('att'), teacherId: sel.value, date, arrival, leave, late, early, deduction: ded};
  state.attendance.push(rec);
  if(ded>0) state.deductions.push({ id: uid('ded'), teacherId: sel.value, criteriaId: 'attendance_auto', kind: 'attendance', date: (new Date()).toISOString(), deduction: ded, note:`ØªØ£Ø®Ø± ${late}Ø¯ Ø§Ù†ØµØ±Ø§Ù ${early}Ø¯`, sessionId: null });
  save(); renderAttendanceTable(); toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø®ØµÙ…');
}
function renderAttendanceTable(){
  const tbody = el('#attendance_table tbody'); if(!tbody) return; tbody.innerHTML='';
  state.attendance.forEach(a=>{
    const t = state.teachers.find(tt=> tt.id===a.teacherId) || {name:'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'};
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(t.name)}</td><td>${a.date}</td><td class="center">${a.arrival}</td><td class="center">${a.leave}</td><td class="center">${a.late}</td><td class="center">${a.early}</td><td class="center">${a.deduction||0}</td><td class="center"><button class="btn ghost delAtt" data-id="${a.id}">Ø­Ø°Ù</button></td>`;
    tbody.appendChild(tr);
  });
  els('.delAtt').forEach(b=> b.addEventListener('click', async e=>{
    const id = e.currentTarget.dataset.id; const ok = await confirmModal('Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±ØŸ'); if(!ok) return;
    const rec = state.attendance.find(x=> x.id===id);
    if(rec){
      state.deductions = state.deductions.filter(d=> !(d.teacherId===rec.teacherId && d.kind==='attendance' && d.date.slice(0,10) === new Date(rec.date).toISOString().slice(0,10)));
    }
    state.attendance = state.attendance.filter(x=> x.id !== id);
    save(); renderAttendanceTable(); toast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
  }));
}

function bindAbsTypeChange(){ const absType = el('#abs_type'); if(!absType) return; absType.addEventListener('change', e=>{ el('#abs_penalty_wrap').style.display = e.target.value==='unexcused' ? 'block' : 'none'; }); }
function saveAbsence(){
  const sel = el('#absence_teacher'); if(!sel || !sel.value) return alert('Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹');
  const date = el('#abs_date').value; if(!date) return alert('Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®');
  const type = el('#abs_type').value; let penalty = 0; if(type==='unexcused') penalty = Number(el('#abs_penalty').value) || 0;
  const rec = { id: uid('abs'), teacherId: sel.value, date, type, penalty };
  state.absences.push(rec);
  if(type==='unexcused' && penalty>0) state.deductions.push({ id: uid('ded'), teacherId: sel.value, criteriaId: 'absence_auto', kind: 'absence', date: (new Date()).toISOString(), deduction: penalty, note:'ØºÙŠØ§Ø¨ Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±', sessionId: null });
  save(); renderAbsences(); toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØºÙŠØ§Ø¨');
}
function renderAbsences(){
  const tbody = el('#absence_table tbody'); if(!tbody) return; tbody.innerHTML='';
  state.absences.forEach(a=>{
    const t = state.teachers.find(tt=> tt.id===a.teacherId) || {name:'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'};
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(t.name)}</td><td>${a.date}</td><td>${a.type}</td><td class="center">${a.penalty||0}</td><td class="center"><button class="btn ghost delAbs" data-id="${a.id}">Ø­Ø°Ù</button></td>`;
    tbody.appendChild(tr);
  });
  els('.delAbs').forEach(b=> b.addEventListener('click', async e=>{
    const id = e.currentTarget.dataset.id; const ok = await confirmModal('Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨ØŸ'); if(!ok) return;
    const rec = state.absences.find(x=> x.id===id);
    if(rec && rec.penalty>0){
      state.deductions = state.deductions.filter(d=> !(d.teacherId===rec.teacherId && d.kind==='absence' && d.date.slice(0,10) === new Date(rec.date).toISOString().slice(0,10)));
    }
    state.absences = state.absences.filter(x=> x.id !== id);
    save(); renderAbsences(); toast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
  }));
}

/* ---------- Summary & Reports ---------- */
function computeTeacherSummary(){
  const crits = state.criteria || [];
  const totalPossible = crits.reduce((s,c)=> s + Number(c.max||0),0);
  const rows = state.teachers.map(t=>{
    const perCriterion = crits.map(c=>{
      const items = state.deductions.filter(d=> d.teacherId===t.id && d.criteriaId===c.id && d.kind===c.kind);
      const totalDed = items.reduce((s,i)=> s + Number(i.deduction||0),0);
      const final = Math.max(0, c.max - totalDed);
      return {id:c.id, name:c.name, max:c.max, totalDed, final, kind:c.kind};
    });
    const sumCriteriaFinals = perCriterion.reduce((s,it)=> s + it.final, 0);
    const absenceSum = state.deductions.filter(d=> d.teacherId===t.id && d.kind==='absence').reduce((s,i)=> s + Number(i.deduction||0),0);
    const attendanceSum = state.deductions.filter(d=> d.teacherId===t.id && d.kind==='attendance').reduce((s,i)=> s + Number(i.deduction||0),0);
    const totalAfterPenalties = Math.max(0, sumCriteriaFinals - (absenceSum + attendanceSum));
    const percent = totalPossible ? ( (totalAfterPenalties / totalPossible) * 100 ) : 0;
    return {teacher: t, perCriterion, absenceSum, attendanceSum, sumCriteriaFinals, totalAfterPenalties, percent, totalPossible};
  });
  return {crits, rows, totalPossible};
}

function renderSummaryReport(){
  const head = el('#summary_head'); const body = el('#summary_body'); if(!head) return;
  el('#reportDate').textContent = 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + (new Date()).toLocaleDateString();
  head.innerHTML = ''; body.innerHTML = '';
  const {crits, rows, totalPossible} = computeTeacherSummary();
  let h = '<tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„ØªØ®ØµØµ</th>';
  crits.forEach(c=> h += `<th>${escapeHtml(c.name)}</th>`);
  h += `<th>Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</th><th>Ø§Ù„ØºÙŠØ§Ø¨</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…</th><th>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</th></tr>`;
  head.innerHTML = h;
  const sorted = rows.slice().sort((a,b)=> b.totalAfterPenalties - a.totalAfterPenalties);
  sorted.forEach((r,index)=>{
    let bg = '';
    if(index===0) bg = 'style="background:#fff6cc"';
    else if(index===1) bg = 'style="background:#f0f0f0"';
    else if(index===2) bg = 'style="background:#ffe0b3"';
    let row = `<tr ${bg}><td>${escapeHtml(r.teacher.name)}</td><td>${escapeHtml(r.teacher.subject||'-')}</td>`;
    r.perCriterion.forEach(p=> row += `<td class="center">${p.final}<div class="small">(-${p.totalDed})</div></td>`);
    row += `<td class="center">${r.attendanceSum}</td><td class="center">${r.absenceSum}</td>`;
    row += `<td class="center">${r.totalAfterPenalties}</td><td class="center">${r.percent.toFixed(1)}%</td></tr>`;
    body.innerHTML += row;
  });
  const bestEl = el('#bestTeacher');
  if(bestEl){
    if(sorted.length===0) bestEl.style.display='none';
    else { const best = sorted[0]; bestEl.style.display='block'; bestEl.innerHTML = `ğŸ… Ø£ÙØ¶Ù„ Ù…Ø¹Ù„Ù…: <strong>${escapeHtml(best.teacher.name)}</strong> â€” Ù†ØªÙŠØ¬Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©: <strong>${best.totalAfterPenalties}</strong> â€” (${best.percent.toFixed(1)}%)`; }
  }
}

/* ---------- Full report ---------- */
function renderFullReport(){
  const head = el('#full_head'); const body = el('#full_body'); const foot = el('#full_foot'); if(!head) return;
  head.innerHTML=''; body.innerHTML=''; foot.innerHTML='';
  const crits = state.criteria || [];
  let h = '<tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„Ø±Ù‚Ù…</th>';
  crits.forEach(c=> h += `<th>${escapeHtml(c.name)}</th><th>Ù…Ø¬Ù…ÙˆØ¹ Ø®ØµÙ…</th><th>Ù†Ø§ØªØ¬</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>`);
  h += '<th>Ø®ØµÙ… Ø§Ù„ØºÙŠØ§Ø¨</th><th>Ø®ØµÙ… Ø§Ù„Ø­Ø¶ÙˆØ±</th><th>Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th></tr>';
  head.innerHTML = h;
  state.teachers.forEach(t=>{
    let row = `<tr><td>${escapeHtml(t.name)}</td><td>${escapeHtml(t.id)}</td>`;
    let sumBonds = 0;
    crits.forEach(c=>{
      const items = state.deductions.filter(d=> d.teacherId===t.id && d.criteriaId===c.id && d.kind===c.kind);
      const totalDed = items.reduce((s,i)=> s + Number(i.deduction||0),0);
      const final = Math.max(0, c.max - totalDed);
      const note = items.length ? items[items.length-1].note || '-' : '-';
      row += `<td class="center">${c.max}</td><td class="center">${totalDed}</td><td class="center">${final}</td><td>${escapeHtml(note)}</td>`;
      sumBonds += final;
    });
    const absenceSum = state.deductions.filter(d=> d.teacherId===t.id && d.kind==='absence').reduce((s,i)=> s + Number(i.deduction||0),0);
    const attendanceSum = state.deductions.filter(d=> d.teacherId===t.id && d.kind==='attendance').reduce((s,i)=> s + Number(i.deduction||0),0);
    const finalScore = Math.max(0, sumBonds - (absenceSum + attendanceSum));
    row += `<td class="center">${absenceSum}</td><td class="center">${attendanceSum}</td><td class="center">${finalScore}</td></tr>`;
    body.innerHTML += row;
  });
  const allMax = state.criteria.reduce((s,c)=> s + Number(c.max||0),0);
  const totalDeductions = state.deductions.reduce((s,d)=> s + Number(d.deduction||0),0);
  const allFinals = state.teachers.reduce((s,t)=> {
    const sumBonds = state.criteria.reduce((a,c)=> a + Math.max(0, c.max - state.deductions.filter(d=> d.teacherId===t.id && d.criteriaId===c.id && d.kind===c.kind).reduce((x,y)=> x + Number(y.deduction||0),0)),0);
    const absenceSum = state.deductions.filter(d=> d.teacherId===t.id && d.kind==='absence').reduce((x,y)=> x + Number(y.deduction||0),0);
    const attendanceSum = state.deductions.filter(d=> d.teacherId===t.id && d.kind==='attendance').reduce((x,y)=> x + Number(y.deduction||0),0);
    return s + Math.max(0, sumBonds - (absenceSum + attendanceSum));
  },0);
  const tr = document.createElement('tr'); tr.className='full-gold';
  tr.innerHTML = `<td colspan="${2 + (state.criteria.length*4) + 3}" style="text-align:left;padding:12px"><strong>Ù…Ù„Ø®Øµ:</strong> Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù†ÙˆØ¯: <strong>${state.criteria.length}</strong> | Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù‚ØµÙˆÙ‰: <strong>${allMax}</strong> | Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©: <strong>${totalDeductions}</strong> | Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: <strong>${allFinals}</strong></td>`;
  foot.appendChild(tr);
}

/* ---------- Export / Import / Backup / Reset ---------- */
function doBackup(){ const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'index27_backup_v3.json'; a.click(); URL.revokeObjectURL(url); toast('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©'); }
function doRestore(){ const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange = e=>{ const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = ev=>{ try{ const obj = JSON.parse(ev.target.result); if(obj && Array.isArray(obj.teachers)){ state = obj; save(); location.reload(); } else alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); }catch(err){ alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ù„Ù'); } }; r.readAsText(f); }; inp.click(); }
async function doReset(){ const ok = await confirmModal('Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ù…ÙˆØ§ÙÙ‚ØŸ'); if(!ok) return; state = {teachers:[], criteria: DEFAULT_CRITERIA.slice(), evaluations:[], deductions:[], attendance:[], absences:[], official:{start:'07:00', end:'13:25', maxAttendancePenalty:2}}; save(); location.reload(); }

/* Import teachers (Excel/CSV) */
function importTeachersFile(file){
  const name = (file.name || '').toLowerCase();
  if(name.endsWith('.csv')){
    const reader = new FileReader();
    reader.onload = (e) => {
      const workbook = XLSX.read(e.target.result, {type:'string', raw:true});
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      processSheetRows(sheet);
    };
    reader.readAsText(file, 'utf-8');
  } else {
    const reader = new FileReader();
    reader.onload = (e) => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      processSheetRows(sheet);
    };
    reader.readAsArrayBuffer(file);
  }
}
function processSheetRows(sheet){
  if(!sheet){ alert('Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­'); return; }
  const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
  if(!rows || rows.length===0){ alert('Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª'); return; }
  const headers = rows[0].map(h => String(h||'').trim());
  const nameIdx = headers.findIndex(h => ['Ø§Ù„Ø§Ø³Ù…','name'].includes(h.toLowerCase()));
  const idIdx = headers.findIndex(h => ['Ø§Ù„Ø±Ù‚Ù…','id','Ø±Ù‚Ù…'].includes(h.toLowerCase()));
  const subjIdx = headers.findIndex(h => ['Ø§Ù„Ù…Ø§Ø¯Ø©','subject','Ø§Ù„Ù…ÙˆØ§Ø¯'].includes(h.toLowerCase()));
  if(nameIdx===-1 || idIdx===-1){ alert('ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„: Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø§Ù„Ø±Ù‚Ù…'); return; }
  let added = 0, skipped = 0;
  for(let i=1;i<rows.length;i++){
    const r = rows[i]; if(!r) continue;
    const name = (r[nameIdx] || '').toString().trim();
    const id = (r[idIdx] || '').toString().trim();
    const subj = subjIdx!==-1 ? (r[subjIdx] || '').toString().trim() : '';
    if(!name || !id){ skipped++; continue; }
    if(state.teachers.some(t=> String(t.id).trim() === String(id).trim())){ skipped++; continue; }
    state.teachers.push({id:String(id), name, subject: subj}); added++;
  }
  save(); renderTeachers(); populateSelects(); renderAllTables(); toast(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${added} Ù…Ø¹Ù„Ù… â€” ØªÙ… ØªØ®Ø·ÙŠ ${skipped} Ø³Ø¬Ù„Ø§Ù‹`);
}

/* ---------- Init & bindings ---------- */
function init(){
  load();
  el('#addTeacher') && el('#addTeacher').addEventListener('click', addTeacher);
  el('#addCi') && el('#addCi').addEventListener('click', addCriterion);
  el('#restoreDefaults') && el('#restoreDefaults').addEventListener('click', restoreDefaults);
  el('#saveDaily') && el('#saveDaily').addEventListener('click', ()=> saveGridSession('daily'));
  el('#saveWeekly') && el('#saveWeekly').addEventListener('click', ()=> saveGridSession('weekly'));
  el('#saveMonthly') && el('#saveMonthly').addEventListener('click', ()=> saveGridSession('monthly'));
  el('#clearDaily') && el('#clearDaily').addEventListener('click', ()=> { buildGridForKind('daily'); toast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¹Ø±ÙˆØ¶'); });
  el('#clearWeekly') && el('#clearWeekly').addEventListener('click', ()=> { buildGridForKind('weekly'); toast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¹Ø±ÙˆØ¶'); });
  el('#clearMonthly') && el('#clearMonthly').addEventListener('click', ()=> { buildGridForKind('monthly'); toast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¹Ø±ÙˆØ¶'); });
  el('#saveAttendance') && el('#saveAttendance').addEventListener('click', saveAttendance);
  el('#clearAttendance') && el('#clearAttendance').addEventListener('click', async ()=>{ const ok=await confirmModal('Ù…Ø³Ø­ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ±ØŸ'); if(!ok) return; state.attendance=[]; state.deductions = state.deductions.filter(d=> d.kind!=='attendance'); save(); renderAttendanceTable(); });
  el('#saveAbsence') && el('#saveAbsence').addEventListener('click', saveAbsence);
  el('#clearAbsence') && el('#clearAbsence').addEventListener('click', async ()=>{ const ok=await confirmModal('Ù…Ø³Ø­ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨ØŸ'); if(!ok) return; state.absences=[]; state.deductions = state.deductions.filter(d=> d.kind!=='absence'); save(); renderAbsences(); });
  el('#backup') && el('#backup').addEventListener('click', doBackup);
  el('#backupTop') && el('#backupTop').addEventListener('click', doBackup);
  el('#restore') && el('#restore').addEventListener('click', doRestore);
  el('#printFull') && el('#printFull').addEventListener('click', ()=> window.print());
  el('#resetAll') && el('#resetAll').addEventListener('click', doReset);
  el('#official_start') && el('#official_start').addEventListener('change', e=>{ state.official.start = e.target.value; save(); });
  el('#official_end') && el('#official_end').addEventListener('change', e=>{ state.official.end = e.target.value; save(); });
  el('#max_att') && el('#max_att').addEventListener('change', e=>{ state.official.maxAttendancePenalty = Number(e.target.value)||2; save(); toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯'); });

  el('#btnImportFile') && el('#btnImportFile').addEventListener('click', ()=> el('#importFile').click());
  el('#importFile') && el('#importFile').addEventListener('change', e=> { const f = e.target.files[0]; if(!f) return; importTeachersFile(f); e.target.value=''; });

  el('#exportExcel') && el('#exportExcel').addEventListener('click', ()=> { alert('ØªØµØ¯ÙŠØ± Excel ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØµØºØ±Ø©'); });
  el('#exportPdf') && el('#exportPdf').addEventListener('click', ()=> { alert('ØªØµØ¯ÙŠØ± PDF ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØµØºØ±Ø©'); });

  bindNav();
  bindAbsTypeChange();

  renderTeachers(); renderCriteria(); populateSelects(); renderAllTables();

  const first = document.querySelector('.nav-btn[data-screen="teachers"]'); if(first) first.classList.add('active'); show('teachers');
  toast('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†');
}

/* ---------- Nav & Settings ---------- */
function bindNav(){ els('.nav-btn').forEach(b=> b.addEventListener('click', ()=>{ els('.nav-btn').forEach(x=> x.classList.remove('active')); b.classList.add('active'); show(b.dataset.screen); })); }
function show(id){
  els('.screen').forEach(s=> s.style.display='none');
  const elc = document.getElementById(id); if(elc) elc.style.display='block';
  if(id==='teachers') renderTeachers();
  if(id==='criteria') renderCriteria();
  if(id==='daily'){ renderGridAndSessions('daily'); }
  if(id==='weekly'){ renderGridAndSessions('weekly'); }
  if(id==='monthly'){ renderGridAndSessions('monthly'); }
  if(id==='attendance'){ renderAttendanceTable(); populateSelects(); }
  if(id==='absences'){ renderAbsences(); populateSelects(); }
  if(id==='summaryReport'){ renderSummaryReport(); }
  if(id==='fullReport') renderFullReport();
  if(id==='settings') renderSettings();
}

function renderSettings(){ el('#official_start').value = state.official.start || '07:00'; el('#official_end').value = state.official.end || '13:25'; el('#max_att').value = state.official.maxAttendancePenalty || 2; }

document.addEventListener('DOMContentLoaded', init);
})();
</script>





 

  <!-- Existing system sections are kept below (loaded from original file via JS) -->

  <!-- New: Teacher Detailed Report -->
  <section id="teacherReport" class="card screen" style="display:block">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:220px">
        <label class="small">Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹</label>
        <select id="report_teacher_select"></select>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="showReport" class="btn">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        <button id="printReport" class="btn ghost">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± (ØµÙØ­Ø© Ù†Ø¸ÙŠÙØ©)</button>
        <button id="downloadPdf" class="btn ghost">ØªØµØ¯ÙŠØ± PDF</button>
      </div>
    </div>

    <div id="reportContainer" style="margin-top:18px;display:none">
      <!-- Professional report card -->
      <div class="report-wrap" id="reportPrintArea">
        <div class="report-header">
          <div>
            <div class="school-info">Ù†Ø¸Ø§Ù… ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† â€” Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</div>
            <div class="report-title" id="r_teacher_name">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</div>
            <div class="muted" id="r_teacher_meta">Ø§Ù„Ø±Ù‚Ù… â€” Ø§Ù„Ù…Ø§Ø¯Ø©</div>
          </div>
          <div class="kpi" id="r_kpis" style="justify-content:flex-end"></div>
        </div>

        <div class="section" id="r_summary_section">
          <h4>Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ</h4>
          <div id="r_summary_text" class="muted">Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹ Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù…ØŒ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ÙˆØ§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©.</div>
        </div>

        <div class="section" id="r_details_section">
          <h4>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ø¨Ù†ÙˆØ¯</h4>
          <div id="r_details_tables"></div>
        </div>

        <div class="section" id="r_att_abs_section">
          <h4>Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</h4>
          <div id="r_attendance_table"></div>
          <div id="r_absence_table" style="margin-top:8px"></div>
        </div>

        <div class="section" id="r_sessions_section">
          
          <div id="r_sessions_list" class="muted"></div>
        </div>

        <div class="section" id="r_notes_section">
          
          <div id="r_notes" class="muted">â€”</div>
        </div>
      </div>
    </div>

  </section>

 
</div>

<!-- include original script (trimmed) and add report functions -->
<script>
/* ====== ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…ÙØµÙ‘Ù„ â€” Ø¥Ø¶Ø§ÙØ§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù… ====== */
(function(){
// We'll reuse the original state stored in localStorage by key 'index27_v2_state_v3'
const STORAGE = 'index27_v2_state_v3';
let state = {teachers:[], criteria:[], deductions:[], evaluations:[], attendance:[], absences:[], official:{start:'07:00', end:'13:25', maxAttendancePenalty:2}};
function loadState(){ try{ const raw = localStorage.getItem(STORAGE); if(raw) state = JSON.parse(raw); if(!state.criteria || state.criteria.length===0) state.criteria = []; }catch(e){ console.warn('KhÃ´ng thá»ƒ táº£i state', e);} }
function saveState(){ try{ localStorage.setItem(STORAGE, JSON.stringify(state)); }catch(e){} }
function el(id){ return document.getElementById(id); }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

loadState();

/* Populate teacher select */
function populateTeacherSelect(){ const sel = el('report_teacher_select'); if(!sel) return; const prev = sel.value; sel.innerHTML=''; const ph = document.createElement('option'); ph.value=''; ph.textContent='-- Ø§Ø®ØªØ± --'; sel.appendChild(ph);
  (state.teachers||[]).forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent = t.name + (t.subject?(' â€” '+t.subject):''); sel.appendChild(o); }); sel.value = prev; }

/* Compute per-teacher details reusing logic from original file */
function computeForTeacher(teacherId){ const crits = state.criteria || []; const perCriterion = crits.map(c=>{
    const items = (state.deductions||[]).filter(d=> d.teacherId===teacherId && d.criteriaId===c.id && d.kind===c.kind);
    const totalDed = items.reduce((s,i)=> s + Number(i.deduction||0),0);
    const final = Math.max(0, c.max - totalDed);
    return {id:c.id,name:c.name,max:c.max,penalty:c.penalty,totalDed,final,kind:c.kind,items};
  });
  const sumCriteriaFinals = perCriterion.reduce((s,p)=> s + p.final,0);
  const absenceSum = (state.deductions||[]).filter(d=> d.teacherId===teacherId && d.kind==='absence').reduce((s,i)=> s + Number(i.deduction||0),0);
  const attendanceSum = (state.deductions||[]).filter(d=> d.teacherId===teacherId && d.kind==='attendance').reduce((s,i)=> s + Number(i.deduction||0),0);
  const totalAfterPenalties = Math.max(0, sumCriteriaFinals - (absenceSum + attendanceSum));
  const totalPossible = crits.reduce((s,c)=> s + Number(c.max||0),0);
  const percent = totalPossible ? ( (totalAfterPenalties/totalPossible)*100 ) : 0;
  // sessions where teacher had deductions
  const sessions = (state.evaluations||[]).filter(s=> (s.deductionIds||[]).some(id=> { const d = (state.deductions||[]).find(dd=> dd.id===id); return d && d.teacherId===teacherId; }));
  const attendanceRecords = (state.attendance||[]).filter(a=> a.teacherId===teacherId);
  const absences = (state.absences||[]).filter(a=> a.teacherId===teacherId);
  return {perCriterion,sumCriteriaFinals,absenceSum,attendanceSum,totalAfterPenalties,percent,totalPossible,sessions,attendanceRecords,absences};
}

/* Render the professional report */
function renderTeacherReport(teacherId){ const teacher = (state.teachers||[]).find(t=> t.id===teacherId); if(!teacher) return alert('Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹'); const data = computeForTeacher(teacherId);
  el('reportContainer').style.display='block';
  el('r_teacher_name').textContent = teacher.name || '-'; 
  el('r_teacher_meta').textContent = (teacher.id||'') + ' â€” ' + (teacher.subject||'-');
  // KPIs
  const kpis = el('r_kpis'); kpis.innerHTML = '';
  const kpiItems = [
    {label:'Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©',value:data.totalAfterPenalties}, 
    {label:'Ø§Ù„Ù†Ø³Ø¨Ø©',value: data.percent.toFixed(1) + '%'},
    {label:'Ø®ØµÙ… Ø§Ù„Ø­Ø¶ÙˆØ±',value: data.attendanceSum},
    {label:'Ø®ØµÙ… Ø§Ù„ØºÙŠØ§Ø¨',value: data.absenceSum}
  ];
  kpiItems.forEach(k=>{ const d=document.createElement('div'); d.className='card-kpi'; d.innerHTML = `<div style="font-weight:900">${escapeHtml(String(k.value))}</div><div class="muted">${escapeHtml(k.label)}</div>`; kpis.appendChild(d); });

  // Summary text
  el('r_summary_text').textContent = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª: ${data.totalAfterPenalties} Ù…Ù† Ø£ØµÙ„ ${data.totalPossible} â€” Ø§Ù„Ù†Ø³Ø¨Ø©: ${data.percent.toFixed(1)}%.`;

  // Details per criterion
  const details = el('r_details_tables'); details.innerHTML = '';
  const grouped = {};
  data.perCriterion.forEach(p=>{ (grouped[p.kind]||(grouped[p.kind]=[])).push(p); });
  for(const kind of ['daily','weekly','monthly']){
    const arr = grouped[kind] || [];
    if(arr.length===0) continue;
    const sec = document.createElement('div'); sec.className='section'; sec.innerHTML = `<h4>Ø¨Ù†ÙˆØ¯ (${kind})</h4>`;
    const tbl = document.createElement('table'); const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰</th><th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø®ØµÙ…</th><th>Ø§Ù„Ù†Ø§ØªØ¬</th></tr>'; tbl.appendChild(thead);
    const tbody = document.createElement('tbody');
    arr.forEach(p=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${escapeHtml(p.name)}</td><td class="center">${p.max}</td><td class="center">${p.totalDed}</td><td class="center">${p.final}</td>`; tbody.appendChild(tr); }); tbl.appendChild(tbody); sec.appendChild(tbl); details.appendChild(sec);
  }

  // Attendance & Absence
  const attWrap = el('r_attendance_table'); attWrap.innerHTML = '';
  if(data.attendanceRecords && data.attendanceRecords.length>0){ const t=document.createElement('table'); t.innerHTML = '<thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø¶ÙˆØ±</th><th>Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</th><th>ØªØ£Ø®Ø± (Ø¯)</th><th>Ø§Ù†ØµØ±Ø§Ù Ù…Ø¨ÙƒØ± (Ø¯)</th><th>Ø®ØµÙ…</th></tr></thead>';
    const tb=document.createElement('tbody'); data.attendanceRecords.forEach(a=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${a.date}</td><td>${a.arrival}</td><td>${a.leave}</td><td class="center">${a.late||0}</td><td class="center">${a.early||0}</td><td class="center">${a.deduction||0}</td>`; tb.appendChild(tr); }); t.appendChild(tb); attWrap.appendChild(t);} else { attWrap.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø¶ÙˆØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù….'; }

  const absWrap = el('r_absence_table'); absWrap.innerHTML = '';
  if(data.absences && data.absences.length>0){ const t=document.createElement('table'); t.innerHTML = '<thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø®ØµÙ…</th></tr></thead>';
    const tb=document.createElement('tbody'); data.absences.forEach(a=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${a.date}</td><td>${a.type}</td><td class="center">${a.penalty||0}</td>`; tb.appendChild(tr); }); t.appendChild(tb); absWrap.appendChild(t);} else { absWrap.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØºÙŠØ§Ø¨ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù….'; }

  // Sessions list
  const sessWrap = el('r_sessions_list'); sessWrap.innerHTML = '';
  if(data.sessions && data.sessions.length>0){ const ul=document.createElement('div'); ul.className='muted'; data.sessions.forEach(s=>{ const ds = new Date(s.date).toLocaleString(); ul.innerHTML += `<div>â€¢ Ø¬Ù„Ø³Ø© (${s.kind}) â€” ${ds} â€” Ø¹Ø¯Ø¯ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø©: ${s.deductionIds? s.deductionIds.filter(id=> state.deductions.find(d=> d.id===id && d.teacherId===teacherId)).length : 0}</div>`; }); sessWrap.appendChild(ul);} else { sessWrap.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù….'; }

  
}

/* Print: open clean window with the report HTML for printing */
function openPrintView(){ const cont = el('reportPrintArea'); if(!cont) return; const win = window.open('', '_blank'); if(!win) return alert('Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ ÙØªØ­ Ø§Ù„Ù†ÙˆØ§ÙØ°');
  // Clone report HTML and attach simple styles for print
  const html = `<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¹Ù„Ù…</title><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{font-family:Arial,Helvetica,sans-serif;padding:20px;color:#071123} table{width:100%;border-collapse:collapse;margin-top:12px} th,td{padding:8px;border:1px solid #ddd;text-align:right} th{background:#f5f5f5;font-weight:800} h2{margin:0 0 8px 0} .muted{color:#666;font-size:13px}</style></head><body>` + cont.innerHTML + `</body></html>`;
  win.document.open(); win.document.write(html); win.document.close();
  // wait a bit then print
  setTimeout(()=>{ win.focus(); win.print(); },400);
}

/* Export PDF: uses print dialog; for better PDF you can use browser's Save as PDF */
function exportPdf(){ openPrintView(); }

/* bindings */
el('showReport').addEventListener('click', ()=>{ const v = el('report_teacher_select').value; if(!v) return alert('Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹'); renderTeacherReport(v); });
el('printReport').addEventListener('click', ()=>{ const v = el('report_teacher_select').value; if(!v) return alert('Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹'); renderTeacherReport(v); openPrintView(); });
el('downloadPdf').addEventListener('click', ()=>{ const v = el('report_teacher_select').value; if(!v) return alert('Ø§Ø®ØªØ± Ù…Ø¹Ù„Ù…Ø§Ù‹'); renderTeacherReport(v); exportPdf(); });

/* initial populate */
populateTeacherSelect();

/* also listen to storage changes so report reflects live data if user edits other tabs */
window.addEventListener('storage', ()=>{ loadState(); populateTeacherSelect(); });

// if the original app exists on the page (user kept full file) we could call its render functions â€” this snippet is intentionally self-contained

})();
</script>
</body>
</html>
